<project name="motu-main-deployment" basedir="." default="deploy">
	<!-- Requirements to use this Ant script 
		===========
		Ant 1.8.2: 
		===========
		download at http://ant.apache.org/bindownload.cgi
		
		===========
		JSch: 
		===========
		download at http://sourceforge.net/projects/jsch/
		then copy jar file to the lib directory of your Ant installation
		
		===========			
		ant-contrib:
		===========
		Download at http://sourceforge.net/projects/ant-contrib/files/
		To install ant-contrib copy ant-contrib-0.3.jar to the lib directory of your Ant installation
		Web site: http://ant-contrib.sourceforge.net/
	-->
	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
	
	<property name="maven.local.repo" value="${user.home}/.m2/repository"/>
	<property name="maven.local.repo.atoll" value="${maven.local.repo}/cls/atoll"/>
	<property name="maven.local.repo.motu" value="${maven.local.repo.atoll}/motu"/>
	<property name="maven.local.repo.motu.config" value="${maven.local.repo.motu}/configuration"/>
	
	<property name="war.ext" value="war"/>
	<property name="jar.ext" value="jar"/>
	<property name="zip.ext" value="tar.gz"/>
	<property name="deploy.name" value="motu"/>
	<property name="start.motu.default" value="start-motu"/>
	<property name="stop.motu.default" value="stop-motu"/>
	<property name="deploy.version.default" value="2.1.15-SNAPSHOT"/>
	<property name="deploy.root.default" value="/opt/atoll"/>
	<property name="host.default" value="misgw-qt.cls.fr"/>
	<property name="username.default" value=""/>
	<property name="password.default" value=""/>
	<property name="tomcat.dir.default" value="tomcat-motu"/>
	<property name="motu.prefix" value="motu-web"/>
	<property name="config.prefix" value="motu-configuration"/>
	<property name="config.prefix.common" value="${config.prefix}-common"/>
	<property name="contexts.prefix" value="atoll-contexts"/>
	<property name="tomcat.resources.prefix" value="motu-library-tomcat-resources"/>
	<property name="motu.servlet.name.default" value="mis-gateway-servlet"/>
	
	<tstamp>
		<format property="now" pattern="yyyy-MM-dd-HH-mm-ss.S"  />
	</tstamp>
	
	
<!--	<echo message="${now}" />
-->	
	
	<!-- //////////////////////////////////////////////////////////////// -->
	<!-- Deploy (main target)  -->
	<!-- //////////////////////////////////////////////////////////////// -->
	<target name="deploy"
		depends="init, stop-motu-web, create-link-tomcat-resources, create-link-motu-commom-config, create-link-motu-config, create-link-motu-web, start-motu-web"
	/> 
	
	
	<!-- ============================ -->
	<!-- Ask options/parameters                         -->
	<!-- ============================ -->
	<target name="prompt">		
		<input message="Host ? " defaultvalue="${host.default}" addproperty="host"/>
		<propertyregex property="hostprefix" input="${host}" regexp="([^\.]*)\.*" select="\1"
			casesensitive="false"/>
		<!--		<echo>${hostprefix}</echo>-->
		<input message="Username ? " defaultvalue="${username.default}" addproperty="username"/>
		<input message="Password ? " defaultvalue="${password.default}" addproperty="password"/>
		<input message="Version to deploy ? " defaultvalue="${deploy.version.default}"
			addproperty="deploy.version"/>
		<input message="Root directory ? " defaultvalue="${deploy.root.default}"
			addproperty="deploy.root"/>
		<input message="Tomcat directory ? " defaultvalue="${tomcat.dir.default}"
			addproperty="tomcat.dir"/>
		
		<input message="Start Motu Web script ? " defaultvalue="${deploy.root}/${start.motu.default}"
			addproperty="start.motu"/>
		<input message="Stop Motu Web script ? " defaultvalue="${deploy.root}/${stop.motu.default}"
			addproperty="stop.motu"/>
		
		<input message="Motu Web package  name (without version) ? "
			defaultvalue="${motu.prefix}"
			addproperty="motu.web.package.name"/>
		
		<input message="Motu Web servlet name  ? "
			defaultvalue="${motu.servlet.name.default}"
			addproperty="motu.servlet.name"/>
		
		<!-- Ask the user  Tomcat resources package deployment -->
		<input message="Deploy Tomcat resources package ${tomcat.resources.prefix}-${deploy.version} [yes, no]? " defaultvalue="no"
			addproperty="tomcat.resources.deploy.response"/>
		
		<condition property="tomcat.resources.deploy" value="true">
			<equals arg1="${tomcat.resources.deploy.response}" arg2="yes" forcestring="true"/>
		</condition>
		
		
		<!-- Ask the user  Motu Common configuration deployment -->
		<input message="Deploy Motu Common Configuration [yes, no]? " defaultvalue="no"
		addproperty="common.config.deploy.response"/>
		
		<condition property="common.config.deploy" value="true">
			<equals arg1="${common.config.deploy.response}" arg2="yes" forcestring="true"/>
		</condition>
		
<!--		<antcall target="common-config-prompt"/>-->
				
		<!-- Ask the user  Motu Custom  configuration deployment -->
		<input message="Deploy Motu  Configuration [yes, no]? " defaultvalue="no"
		addproperty="config.deploy.response"/>
		
		<condition property="config.deploy" value="true">
			<equals arg1="${config.deploy.response}" arg2="yes" forcestring="true"/>
		</condition>
		
<!--		<antcall target="config-prompt"/>-->
		
		
<!--		<propertyregex property="config.suffix" input="${config.package.name}"
			regexp="${config.prefix}-([^\.]*)-${deploy.version}" select="\1" casesensitive="false"/>
		<property name="config.prefix.custom.pathname" value="${config.prefix}-${config.suffix}"/>
-->		
		
		
	</target>
	
	<!-- ============================ -->
	<!-- Ask  Motu common configuration options  -->
	<!-- ============================ -->
	<target name="common-config-prompt" if="common.config.deploy">
		<input message="Motu Common configuration package  name  (without version)  ? "
		defaultvalue="${config.prefix.common}"
		addproperty="common.config.package.name"/>
	</target>
	
	<!-- ============================ -->
	<!-- Ask  Motu configuration options  -->
	<!-- ============================ -->
	<target name="config-prompt" if="config.deploy">
		<input message="Motu Custom Configuration package  name  (without version)  ? "
			defaultvalue="${config.prefix}-${hostprefix}"
			addproperty="config.package.name"/>
		
		<input message="Motu Custom Configuration package  version  ? "
			defaultvalue="${deploy.version}"
			addproperty="config.deploy.version"/>
		
	</target>
	
	<!-- ============================ -->
	<!-- Initialisation  -->
	<!-- ============================ -->
	<target name="init" depends="prompt, common-config-prompt, config-prompt, check-maven-motu-web, check-maven-common-config, check-maven-config, check-maven-tomcat-resources"> 
		
		<!-- Set remote directory name  -->
		<property name="motu.remote.dir" value="${motu.web.package.name}-${deploy.version}"/>
		<property name="config.remote.dir" value="${config.package.name}-${config.deploy.version}"/>
		<property name="common.config.remote.dir" value="${common.config.package.name}-${deploy.version}"/>
				
		<!-- Ask the user to confirm deployment -->
		<input message="Are you sure to deploy Motu on ${host} [yes, no]? " defaultvalue="no"
		addproperty="accept.deploy"/>
		
		<fail message="Deployment cancelled by user.">
			<condition>
				<not>
					<equals arg1="${accept.deploy}" arg2="yes" casesensitive="true"/>
				</not>
			</condition>
		</fail>
		
				
	</target>
	
	<!-- ============================ -->
	<!-- check tomcat resources  is in the maven local repository -->
	<!-- ============================ -->	
	<target name="check-maven-tomcat-resources" if="tomcat.resources.deploy">
		<property name="tomcat.resources.package.jar"
			value="${tomcat.resources.prefix}-${deploy.version}.jar"/>
		<property name="tomcat.resources.package.jar.local"
			value="${maven.local.repo.motu}/library/${tomcat.resources.prefix}/${deploy.version}/${tomcat.resources.package.jar}"/>		
		<fail message="File ${tomcat.resources.package.jar.local} is mssing.">
			<condition>
				<not>
					<available file="${tomcat.resources.package.jar.local}"
						property="tomcat.resources.package.jar.present"/>
				</not>					
			</condition>
		</fail>			
		
	</target>
		
	<!-- ============================ -->
	<!-- check motu web  is in the maven local repository -->
	<!-- ============================ -->	
	<target name="check-maven-motu-web">		
		<property name="motu.web.package.jar" value="${motu.web.package.name}-${deploy.version}.${war.ext}"/>
		<property name="motu.web.package.jar.local"
			value="${maven.local.repo.motu}/motu-web/${deploy.version}/${motu.web.package.jar}"
		/>
		<fail message="File ${motu.web.package.jar.local} is mssing.">
			<condition>
				<not>
					<available file="${motu.web.package.jar.local}"
						property="motu.web.package.jar.present"/>
				</not>					
			</condition>
		</fail>			
	</target>
		
	<!-- ============================ -->
	<!-- check motu common configuration jar is in the maven local repository -->
	<!-- ============================ -->	
	<target name="check-maven-common-config" if="common.config.deploy" >				
		<property name="common.config.package.jar" value="${common.config.package.name}-${deploy.version}-delivery.${zip.ext}"/>
		<property name="common.config.package.jar.local"
			value="${maven.local.repo.motu.config}/${config.prefix.common}/${deploy.version}/${common.config.package.jar}"
		/>
		<fail message="File ${common.config.package.jar.local} is mssing.">
			<condition>
				<not>
					<available file="${common.config.package.jar.local}"
						property="common.config.package.jar.present"/>
				</not>
			</condition>
		</fail>
		
	</target>
	
	<!-- ============================ -->
	<!-- check motu custom configuration jar is in the maven local repository -->
	<!-- ============================ -->	
	<target name="check-maven-config" if="config.deploy" >		
		<property name="config.package.jar" value="${config.package.name}-${config.deploy.version}-delivery.${zip.ext}"/>
		<property name="config.package.jar.local"
			value="${maven.local.repo.motu.config}/${config.package.name}/${config.deploy.version}/${config.package.jar}"
		/>
		<fail message="File ${config.package.jar.local} is mssing.">
			<condition>
				<not>
					<available file="${config.package.jar.local}"
						property="config.package.jar.present"/>
				</not>
			</condition>
		</fail>
		
		
	</target>
	
	<!-- ============================ -->
	<!-- Stop  motu web -->
	<!-- ============================ -->	
	<target name="stop-motu-web">
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			command="${stop.motu}" failonerror="false"/>

		<sleep seconds="10"/>

	</target>
	<!-- ============================ -->
	<!-- Start motu web -->
	<!-- ============================ -->	
	<target name="start-motu-web"> 
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			command="${start.motu}" failonerror="true"/>
			
	</target>
	<!-- ============================ -->
	<!-- Checks if motu-web directory exists -->
	<!-- ============================ -->	
	<target name="check-dir-motu-web">	
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" outputproperty="rc-motu"
			command="find  ${deploy.root} -name ${motu.remote.dir}  | wc -l"/>
		<echo message="sshexec_rc = ${rc-motu}"/>
		<propertyregex property="check-motu-web" input="${rc-motu}" regexp="([\d]*)\.*" select="\1"
			casesensitive="false"/>
		
		<echo message="check-motu-web = ${check-motu-web}"/>
		<condition property="move-motu-web" value="true">
			<equals arg1="${check-motu-web}" arg2="1" forcestring="true"/>
		</condition>
				
		<echo message="move-motu-web = ${move-motu-web}"/>
	</target>
	
	<!-- ============================ -->
	<!-- Move motu web directory to a temp directory if exists -->
	<!-- ============================ -->
	<target name="move-dir-motu-web"  depends="check-dir-motu-web" if="move-motu-web">
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="mv  ${deploy.root}/${motu.remote.dir} ${deploy.root}/${motu.remote.dir}.${now}"/>		
	</target>
	
	<!-- ============================ -->
	<!-- Checks if  motu config directory exists -->
	<!-- ============================ -->	
	<target name="check-dir-motu-config"  if="config.deploy">	
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" outputproperty="rc-config"
			command="find  ${deploy.root} -name ${config.remote.dir}  | wc -l"/>
		<echo message="sshexec_rc = ${rc-config}"/>
		<propertyregex property="check-motu-config" input="${rc-config}" regexp="([\d]*)\.*" select="\1"
			casesensitive="false"/>
		
		<echo message="check-motu-config = ${check-motu-config}"/>
		<condition property="move-motu-config" value="true">
			<equals arg1="${check-motu-config}" arg2="1" forcestring="true"/>
		</condition>
		
		<echo message="move-motu-config = ${move-motu-config}"/>
	</target>	
	
	<!-- ============================ -->
	<!-- Move motu config directory to a temp directory if exists -->
	<!-- ============================ -->
	<target name="move-dir-motu-config"  depends="check-dir-motu-config" if="move-motu-config">
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="mv  ${deploy.root}/${config.remote.dir} ${deploy.root}/${config.remote.dir}.${now}"/>
		
	</target>
	
	<!-- ============================ -->
	<!-- Checks if  motu common config directory exists -->
	<!-- ============================ -->	
	<target name="check-dir-motu-common-config"  if="common.config.deploy">	
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" outputproperty="rc-common-config"
			command="find  ${deploy.root} -name ${common.config.remote.dir}  | wc -l"/>
		<echo message="sshexec_rc = ${rc-common-config}"/>
		<propertyregex property="check-motu-common-config" input="${rc-common-config}" regexp="([\d]*)\.*" select="\1"
			casesensitive="false"/>
		
		<echo message="check-motu-common-config = ${check-motu-common-config}"/>
		<condition property="move-motu-common-config" value="true">
			<equals arg1="${check-motu-common-config}" arg2="1" forcestring="true"/>
		</condition>
		
		<echo message="move-motu-common-config = ${move-motu-common-config}"/>
	</target>	
	
	<!-- ============================ -->
	<!-- Move motu common config directory to a temp directory if exists -->
	<!-- ============================ -->
	<target name="move-dir-motu-common-config"  depends="check-dir-motu-common-config" if="move-motu-common-config">
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="mv  ${deploy.root}/${common.config.remote.dir} ${deploy.root}/${common.config.remote.dir}.${now}"/>
		
	</target>
	
	<!-- ============================ -->
	<!-- Process motu configuration package on the remote host -->
	<!--  Copy tar.gz file, untar, remove tar.gz file -->
	<!-- ============================ -->
	<target name="process-package-motu-config" depends="move-dir-motu-config"  if="config.deploy">
		<scp localFile="${config.package.jar.local}"
			remoteTodir="${username}@${host}:${deploy.root}" password="${password}" trust="true"/>	
		
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="cd ${deploy.root}; tar -zxf  ${deploy.root}/${config.package.jar};rm -f ${deploy.root}/${config.package.jar}"/>
	</target>
	
	<!-- ============================ -->
	<!-- Process motu common configuration package on the remote host -->
	<!--  Copy tar.gz file, untar, remove tar.gz file -->
	<!-- ============================ -->
	<target name="process-package-motu-common-config" depends="move-dir-motu-common-config"  if="common.config.deploy">
		<scp localFile="${common.config.package.jar.local}"
			remoteTodir="${username}@${host}:${deploy.root}" password="${password}" trust="true"/>	
		
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="cd ${deploy.root}; tar -zxf  ${deploy.root}/${common.config.package.jar};rm -f ${deploy.root}/${common.config.package.jar}"/>
	</target>
	
	
	<!-- ============================ -->
	<!-- Process atoll-is package on the remote host -->
	<!--  Copy war file, create directory, unjar, remove war file -->
	<!-- ============================ -->
	<target name="process-package-motu-web" depends="move-dir-motu-web">
		<scp localFile="${motu.web.package.jar.local}"
			remoteTodir="${username}@${host}:${deploy.root}" password="${password}" trust="true"/>	
		
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="cd ${deploy.root}; mkdir ${motu.remote.dir}; cd ${motu.remote.dir}; jar -xf ${deploy.root}/${motu.web.package.jar}; rm -f ${deploy.root}/${motu.web.package.jar}"/>
		
	</target>
	
	<!-- ============================ -->
	<!-- Create link to atoll motu web -->
	<!-- ============================ -->
	<target name="create-link-motu-web" depends="process-package-motu-web">
		<property name="tomcat-motu-webapps" value="${deploy.root}/${tomcat.dir}/webapps" />
		<!-- Remove link to atoll-is in tomcat webapps directory. 
		Use an specific sshexec task with  failonerror="false" if link doesn't exist -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" command="rm ${tomcat-motu-webapps}/${motu.servlet.name}"/>

		<!-- Create link to atoll-is in tomcat webapps directory -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" command="cd ${tomcat-motu-webapps}; ln -s ${deploy.root}/${motu.remote.dir} ${motu.servlet.name}"/>

	</target>
	<!-- ============================ -->
	<!-- Create link to motu configuration -->
	<!-- ============================ -->
	<target name="create-link-motu-config" depends="process-package-motu-config"  if="config.deploy">
		<!-- Remove link to motu configuration in the deploy root directory. 
			Use an specific sshexec task with  failonerror="false" if link doesn't exist -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" command="rm ${deploy.root}/${config.package.name}"/>
		
		<!-- Create link to motu configuration in the deploy root  directory -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" command="cd ${deploy.root}; ln -s ${deploy.root}/${config.remote.dir} ${config.package.name}"/>
		
	</target>
	<!-- ============================ -->
	<!-- Create link to motu common configuration -->
	<!-- ============================ -->
	<target name="create-link-motu-commom-config" depends="process-package-motu-common-config"  if="common.config.deploy">
		<!-- Remove link to motu common configuration in the deploy root directory. 
			Use an specific sshexec task with  failonerror="false" if link doesn't exist -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" command="rm ${deploy.root}/${common.config.package.name}"/>
		
		<!-- Create link to motu common configuration in the deploy root  directory -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" command="cd ${deploy.root}; ln -s ${deploy.root}/${common.config.remote.dir} ${common.config.package.name}"/>
		
	</target>
	
	<!-- ============================ -->
	<!-- Checks if  tomcat resources package exists -->
	<!-- ============================ -->	
	<target name="check-package-tomcat-resources"  if="tomcat.resources.deploy">	
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" outputproperty="rc-tomcat-resources"
			command="find  ${deploy.root} -name ${tomcat.resources.package.jar}  | wc -l"/>
		<echo message="sshexec_rc = ${rc-tomcat-resources}"/>
		<propertyregex property="check-tomcat-resources" input="${rc-tomcat-resources}" regexp="([\d]*)\.*" select="\1"
			casesensitive="false"/>
		
		<echo message="check-tomcat-resources = ${check-tomcat-resources}"/>
		<condition property="move-tomcat-resources" value="true">
			<equals arg1="${check-tomcat-resources}" arg2="1" forcestring="true"/>
		</condition>
		
		<echo message="move-tomcat-resources = ${move-tomcat-resources}"/>
	</target>	

	<!-- ============================ -->
	<!-- Move tomcat resources package to a temp package if exists -->
	<!-- ============================ -->
	<target name="move-package-tomcat-resources"  depends="check-package-tomcat-resources" if="move-tomcat-resources">
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" 
			command="mv ${deploy.root}/${tomcat.resources.package.jar} ${deploy.root}/${tomcat.resources.package.jar}.${now}"/>
		
	</target>
	

	<!-- ============================ -->
	<!-- Process tomcat-resources package on the remote host -->
	<!--  Copy jar file, -->
	<!-- ============================ -->
	<target name="process-package-tomcat-resources" depends="move-package-tomcat-resources"  if="tomcat.resources.deploy">
		<scp localFile="${tomcat.resources.package.jar.local}"
			remoteTodir="${username}@${host}:${deploy.root}" password="${password}" trust="true"/>			
	</target>
	

	<!-- ============================ -->
	<!-- Create link to tomcat resources -->
	<!-- ============================ -->
	<target name="create-link-tomcat-resources" depends="process-package-tomcat-resources"  if="tomcat.resources.deploy">
		<!-- Remove link to tomcat resources in tomcat lib directory. 
			Use an specific sshexec task with  failonerror="false" if link doesn't exist -->
		<property name="tomcat-resources-link" value="${tomcat.resources.prefix}.jar"></property>
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="false" command="rm ${deploy.root}/${tomcat.dir}/lib/${tomcat-resources-link}"/>
		
		<!-- Create link to to tomcat resources in tomcat lib directory. -->
		<sshexec host="${host}" username="${username}" password="${password}" trust="true"
			failonerror="true" command="cd ${deploy.root}/${tomcat.dir}/lib; ln -s ${deploy.root}/${tomcat.resources.package.jar} ${tomcat-resources-link}"/>
		
	</target>

</project>